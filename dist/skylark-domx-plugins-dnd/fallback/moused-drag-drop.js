/**
 * skylark-domx-plugins-dnd - The dnd features enhancement for dom.
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["skylark-langx","skylark-domx-noder","skylark-domx-query","skylark-domx-eventer","skylark-domx-styler","skylark-domx-finder","skylark-domx-plugins-scrolls/auto-scroll","./data-transfer"],function(t,e,s,i,n,r,o,a){"use strict";var l=t.Emitter.inherit({_construct:function(t,e,i){this.dnd=t,this._dragSource=e,this._ptDown=i,this._lastClick=0,this._isDragEnabled=!0,this._dataTransfer=new a;var n=s(document);this.listenTo(n,"mousemove",this._onMouseMove),this.listenTo(n,"mouseup",this._onMouseUp)},_onMouseMove:function(t){if(this._shouldCancelPressHoldMove(t))this._reset();else if(this._shouldHandleMove(t)||this._shouldHandlePressHoldMove(t)){var e=this._getTarget(t);this._dragSource&&!this._img&&this._shouldStartDragging(t)&&(this._dispatchEvent(t,"dragstart",this._dragSource),this._createImage(t),this._dispatchEvent(t,"dragenter",e)),this._img&&(this._lastTouch=t,t.preventDefault(),e!=this._lastTarget&&(this._dispatchEvent(this._lastTouch,"dragleave",this._lastTarget),this._dispatchEvent(t,"dragenter",e),this._lastTarget=e),this._moveImage(t),this._isDropZone=this._dispatchEvent(t,"dragover",e)),this._handleAutoScroll(t)}},_onMouseUp:function(t){this._shouldHandle(t)&&(this._destroyImage(),this._dragSource&&(t.type.indexOf("cancel")<0&&this._isDropZone&&this._dispatchEvent(this._lastTouch,"drop",this._lastTarget),this._dispatchEvent(this._lastTouch,"dragend",this._dragSource))),this.destroy()},_shouldHandle:function(t){return t&&!t.defaultPrevented},_shouldHandleMove:function(t){return!l._ISPRESSHOLDMODE&&this._shouldHandle(t)},_shouldHandlePressHoldMove:function(t){return l._ISPRESSHOLDMODE&&this._isDragEnabled},_shouldCancelPressHoldMove:function(t){return l._ISPRESSHOLDMODE&&!this._isDragEnabled&&this._getDelta(t)>l._PRESSHOLDMARGIN},_shouldStartDragging:function(t){var e=this._getDelta(t);return e>l._THRESHOLD||l._ISPRESSHOLDMODE&&e>=l._PRESSHOLDTHRESHOLD},_reset:function(){this._destroyImage(),this._dragSource=null,this._lastTouch=null,this._lastTarget=null,this._ptDown=null,this._isDragEnabled=!1,this._isDropZone=!1,this._dataTransfer=null,clearInterval(this._pressHoldInterval),this.pointerElemChangedInterval&&(clearInterval(this.pointerElemChangedInterval),this.pointerElemChangedInterval=null),this.autoscroller&&(this.autoscroller.destroy(),this.autoscroller=null)},_getPoint:function(t,e){return{x:e?t.pageX:t.clientX,y:e?t.pageY:t.clientY}},_getDelta:function(t){if(l._ISPRESSHOLDMODE&&!this._ptDown)return 0;var e=this._getPoint(t);return Math.abs(e.x-this._ptDown.x)+Math.abs(e.y-this._ptDown.y)},_getTarget:function(t){for(var e=this._getPoint(t),s=document.elementFromPoint(e.x,e.y);s&&"none"==getComputedStyle(s).pointerEvents;)s=s.parentElement;return s},_createImage:function(t){this._img&&this._destroyImage(),this._imgCustom=this._dataTransfer._imgCustom,this._imgOffset=this._dataTransfer._imgOffset;var e=this._imgCustom||this._dragSource;if(this._img=e.cloneNode(!0),this._copyStyle(e,this._img),this._img.style.top=this._img.style.left="-9999px",!this._imgCustom){var s=e.getBoundingClientRect(),i=this._getPoint(t);this._imgOffset={x:i.x-s.left,y:i.y-s.top},this._img.style.opacity=l._OPACITY.toString()}this._moveImage(t),document.body.appendChild(this._img)},_destroyImage:function(){this._img&&e.remove(this._img),this._img=null,this._imgCustom=null},_moveImage:function(e){var s=this;t.defer(function(){if(s._img){var t=s._getPoint(e,!0);n.css(s._img,{position:"absolute",pointerEvents:"none",zIndex:"999999",left:Math.round(t.x-s._imgOffset.x)+"px",top:Math.round(t.y-s._imgOffset.y)+"px"})}})},_copyProps:function(t,e,s){for(var i=0;i<s.length;i++){var n=s[i];t[n]=e[n]}},_copyStyle:function(t,e){if(l._rmvAtts.forEach(function(t){e.removeAttribute(t)}),t instanceof HTMLCanvasElement){var s=t,i=e;i.width=s.width,i.height=s.height,i.getContext("2d").drawImage(s,0,0)}for(var n=getComputedStyle(t),r=0;r<n.length;r++){var o=n[r];o.indexOf("transition")<0&&(e.style[o]=n[o])}e.style.pointerEvents="none";for(r=0;r<t.children.length;r++)this._copyStyle(t.children[r],e.children[r])},_dispatchEvent:function(t,e,s){if(t&&s){var i=document.createEvent("Event"),n=t.touches?t.touches[0]:t;return i.initEvent(e,!0,!0),i.button=0,i.which=i.buttons=1,this._copyProps(i,t,l._kbdProps),this._copyProps(i,n,l._ptProps),i.dataTransfer=this._dataTransfer,s.dispatchEvent(i),i.defaultPrevented}return!1},_closestDraggable:function(t){for(;t;t=t.parentElement)if(t.hasAttribute("data-draggable"))return t;return null},_handleAutoScroll:function(t){var e=this.dnd,s=t.clientX,i=t.clientY;document.elementFromPoint(s,i);if(!this.pointerElemChangedInterval||s!==this.lastPointerElemX||i!==this.lastPointerElemY){this.pointerElemChangedInterval&&clearInterval(this.pointerElemChangedInterval);var n=null;this.pointerElemChangedInterval=setInterval(function(){var t=r.scrollableParent(document.elementFromPoint(s,i),!0);t!==n&&(n=t,this.autoscroller&&(this.autoscroller.destroy(),this.autoscroller=null),this.autoscroller=new o(n,e.dragging.options),this.autoscroller.handle(s,i))},10),this.lastPointerElemX=s,this.lastPointerElemY=i}},destroy:function(){this.unlistenTo(),this._reset()}});return l._THRESHOLD=5,l._OPACITY=.5,l._DBLCLICK=500,l._CTXMENU=900,l._ISPRESSHOLDMODE=!1,l._PRESSHOLDAWAIT=400,l._PRESSHOLDMARGIN=25,l._PRESSHOLDTHRESHOLD=0,l._rmvAtts="id,class,style,draggable".split(","),l._kbdProps="altKey,ctrlKey,metaKey,shiftKey".split(","),l._ptProps="pageX,pageY,clientX,clientY,screenX,screenY".split(","),l});
//# sourceMappingURL=../sourcemaps/fallback/moused-drag-drop.js.map
